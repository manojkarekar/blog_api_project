{% extends './pages/base.html' %} {% block main_container %}
<div>
  <div class="container d-flex justify-content-between">
    {% if request.user.is_authenticated %}
    <p>
      Welcome, {{ request.user.first_name }} {{ request.user.last_name }}! You
      are logged in.
    </p>
    <a href="#" id="logout" class="btn btn-info btn-sm">Logout</a>
    {% else %}
    <a href="{% url 'user-login' %}" class="btn btn-info btn-sm">Login</a>
    {% endif %}
  </div>

  <h1>Blogs</h1>
</div>
{% endblock main_container %} {% block custom_js %}
<script>
  $(document).ready(function () {
    checkLoginStatus(); // ✅ Check user login status on page load

    $("#logout").click(function (event) {
      event.preventDefault();
      logoutUser();
    });
  });

  // ✅ Function to check if user is already logged in
  function checkLoginStatus() {
    let authToken = localStorage.getItem("authToken");

    if (!authToken) {
      console.log("No auth token found. Redirecting to login...");
      window.location.href = "/user/login/";
      return;
    }

    $.ajax({
      type: "GET",
      url: "/api/check-login/",
      headers: { Authorization: "Bearer " + authToken },
      success: function (response) {
        if (!response.logged_in) {
          redirectToLogin();
        }
      },
      error: function () {
        redirectToLogin();
      },
    });
  }

  // ✅ Function to log out user
  function logoutUser() {
    $.ajax({
      type: "POST",
      url: "/user/logout/",
      headers: { "X-CSRFToken": getCookie("csrftoken") },
      success: function () {
        localStorage.removeItem("authToken"); // ✅ Clear token
        alert("Logout successful!");
        window.location.href = "/user/login/";
      },
      error: function () {
        alert("Logout failed! Please try again.");
      },
    });
  }

  // ✅ Redirect to login page and remove auth token
  function redirectToLogin() {
    localStorage.removeItem("authToken");
    window.location.href = "/user/login/";
  }

  // ✅ Function to get CSRF token from cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie) {
      document.cookie.split(";").forEach((cookie) => {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.split("=")[1]);
        }
      });
    }
    return cookieValue;
  }
</script>
{% endblock custom_js %}
